---
description: Comprehensive rules for working with Smali code and APK decompilation projects
globs: "**/*.{smali,apk,dex,xml,yml,yaml,json}"
alwaysApply: false
---

# Quy Tắc Làm Việc Với Smali
description: Comprehensive rules for working with Smali code and APK decompilation projects
globs: "**/*.{smali,apk,dex,xml,yml,yaml,json}"

## Nguyên Tắc Cơ Bản
- ***BẮT BUỘC*** phân tích cấu trúc APK và AndroidManifest.xml trước khi chỉnh sửa
- ***BẮT BUỘC*** xác định thành phần chính: Activities, Services, Receivers, Providers
- ***BẮT BUỘC*** sử dụng công cụ phù hợp: apktool, jadx, dex2jar, jd-gui
- ***BẮT BUỘC*** lưu trữ APK gốc và tạo backup sau mỗi chỉnh sửa lớn
- ***BẮT BUỘC*** hiểu rõ cú pháp Dalvik bytecode và kiểu dữ liệu trong Smali
- ***KHUYẾN NGHỊ*** sử dụng công cụ tự động hóa để giảm thiểu lỗi thủ công

## Khi Làm Việc Với Code Smali
- Duy trì cấu trúc try-catch, .locals, .registers khi chỉnh sửa
- Thêm comment chi tiết trước mỗi thay đổi trong code
- Cẩn thận với invoke-* instructions và jump labels
- Kiểm tra tính nhất quán của tham chiếu và resource IDs
- Không vô hiệu hóa các cơ chế bảo mật quan trọng
- Kiểm tra mã trước khi recompile, ký và zipalign APK
- Sử dụng logcat và các công cụ như Frida để debug
- Tuân thủ đạo đức và quy định pháp luật về reverse engineering

## Nâng Cấp APK Với Module Mới
Khi cần tích hợp module Java không phụ thuộc resource vào APK hiện có, hãy tham khảo:
- ***BẮT BUỘC*** tuân thủ quy trình trong file [smali-module-integration.mdc](mdc:smali-module-integration.mdc)
- ***KHUYẾN NGHỊ*** sử dụng công cụ tự động hóa thay vì thực hiện thủ công
- ***KHUYẾN NGHỊ*** kiểm tra tính tương thích trước và sau khi tích hợp

## Công Cụ Hỗ Trợ
Dự án cung cấp các công cụ hỗ trợ quy trình làm việc với Smali:
- **APK Module Integrator**: Công cụ tự động tích hợp module smali vào dự án
  - Vị trí: `tools/apk-module-integrator.py`
  - Hướng dẫn: `tools/README-apk-integrator.md`

## Quy Trình Nâng Cấp APK Tối Ưu
1. Decompile APK cần nâng cấp và APK chứa module
2. Sử dụng công cụ tích hợp module để copy module từ nguồn sang đích
3. Kiểm tra và chỉnh sửa AndroidManifest.xml nếu cần thiết
4. Biên dịch lại APK với apktool
5. Ký và tối ưu APK

## Xử Lý Trường Hợp Đặc Biệt
- **Nhiều thư mục smali**: Đặt module vào thư mục tiếp theo (smali_classes x+1)
- **Xung đột tên package**: Đổi tên package trong module nếu có thể
- **Xung đột API**: Kiểm tra tương thích API giữa module và APK đích

## Tài Liệu Tham Khảo
- [Smali Syntax Guide](mdc:https:/github.com/JesusFreke/smali/wiki/TypesMethodsAndFields)
- [APK Tool Documentation](mdc:https:/ibotpeaches.github.io/Apktool)
- [Android Bytecode Reference](mdc:https:/source.android.com/devices/tech/dalvik)

@file ../tools/README-apk-integrator.md
@file ../tools/apk-module-integrator.py 