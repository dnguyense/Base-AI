---
description: 
globs: 
alwaysApply: false
---
# Quy TrÃ¬nh TÃ­ch Há»£p APK TÆ°Æ¡ng TÃ¡c
description: Quy trÃ¬nh tÆ°Æ¡ng tÃ¡c Ä‘á»ƒ tÃ­ch há»£p package tá»« APK nguá»“n vÃ o APK Ä‘Ã­ch
globs: "**/*.{apk,smali,xml}"

## NguyÃªn Táº¯c TÆ°Æ¡ng TÃ¡c
- ***Báº®T BUá»˜C*** thu tháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin trÆ°á»›c khi thá»±c hiá»‡n
- ***Báº®T BUá»˜C*** giáº£i thÃ­ch tá»«ng bÆ°á»›c Ä‘ang thá»±c hiá»‡n
- ***Báº®T BUá»˜C*** kiá»ƒm tra káº¿t quáº£ sau má»—i bÆ°á»›c quan trá»ng
- ***KHUYáº¾N NGHá»Š*** cung cáº¥p thÃ´ng tin há»¯u Ã­ch trong quÃ¡ trÃ¬nh thá»±c hiá»‡n

## Quy TrÃ¬nh Thu Tháº­p ThÃ´ng Tin
Khi nháº­n yÃªu cáº§u tÃ­ch há»£p APK, ***PHáº¢I*** thu tháº­p Ä‘áº§y Ä‘á»§ cÃ¡c thÃ´ng tin sau báº±ng cÃ¡ch há»i tuáº§n tá»±:

### 0. XÃ¡c Äá»‹nh Nguá»“n APK
```
Báº¡n muá»‘n sá»­ dá»¥ng:
1. Project Android Ä‘á»ƒ build APK nguá»“n
2. APK Ä‘Ã£ build sáºµn

Vui lÃ²ng chá»n tÃ¹y chá»n (1 hoáº·c 2):
```

### 1a. Náº¿u Chá»n Project Android
```
Vui lÃ²ng cung cáº¥p Ä‘Æ°á»ng dáº«n Ä‘áº¿n project Android nguá»“n:
```

Sau Ä‘Ã³ phÃ¢n tÃ­ch project:
```bash
# Kiá»ƒm tra Gradle wrapper
if [ -f "[Ä‘Æ°á»ng_dáº«n_project]/gradlew" ]; then
  chmod +x "[Ä‘Æ°á»ng_dáº«n_project]/gradlew"
  echo "ÄÃ£ tÃ¬m tháº¥y Gradle wrapper"
else
  echo "KhÃ´ng tÃ¬m tháº¥y Gradle wrapper, sáº½ sá»­ dá»¥ng Gradle toÃ n cá»¥c"
fi

# Liá»‡t kÃª cÃ¡c module
MODULES=$(grep "include " "[Ä‘Æ°á»ng_dáº«n_project]/settings.gradle" | sed -e "s/include//g" -e "s/'//g" -e "s/://g" -e "s/,//g")
echo "CÃ¡c module cÃ³ thá»ƒ build: $MODULES"
```

Há»i ngÆ°á»i dÃ¹ng:
```
Dá»± Ã¡n cÃ³ cÃ¡c module sau:
[danh_sÃ¡ch_modules]

Báº¡n muá»‘n build module nÃ o? (nháº­p tÃªn module, máº·c Ä‘á»‹nh lÃ  'app'):
```

### 1b. Náº¿u Chá»n APK ÄÃ£ Build Sáºµn
```
Báº¡n vui lÃ²ng cung cáº¥p Ä‘Æ°á»ng dáº«n Ä‘áº¿n file APK nguá»“n (chá»©a package cáº§n tÃ­ch há»£p):
```

### 2. APK ÄÃ­ch
```
ÄÆ°á»ng dáº«n Ä‘áº¿n file APK Ä‘Ã­ch (APK cáº§n Ä‘Æ°á»£c tÃ­ch há»£p package vÃ o) lÃ  gÃ¬?
```

### 3. Package/Class Path
```
Package hoáº·c class path báº¡n muá»‘n tÃ­ch há»£p lÃ  gÃ¬? (vÃ­ dá»¥: com/miui hoáº·c com/example/feature)
```

### 4. XÃ¡c Nháº­n ThÃ´ng Tin
```
TÃ´i sáº½ thá»±c hiá»‡n tÃ­ch há»£p vá»›i cÃ¡c thÃ´ng tin sau:
- Nguá»“n: [Project Android / APK nguá»“n]
- [Náº¿u lÃ  Project] Module sáº½ build: [tÃªn_module]
- APK Ä‘Ã­ch: [Ä‘Æ°á»ng_dáº«n_Ä‘Ã­ch]
- Package cáº§n tÃ­ch há»£p: [package_path]

Báº¡n xÃ¡c nháº­n lÃ  chÃ­nh xÃ¡c chá»©?
```

## Quy TrÃ¬nh Thá»±c Hiá»‡n
Sau khi thu tháº­p Ä‘á»§ thÃ´ng tin, thá»±c hiá»‡n cÃ¡c bÆ°á»›c sau:

### 1. Táº¡o ThÆ° Má»¥c LÃ m Viá»‡c
```
TÃ´i sáº½ táº¡o thÆ° má»¥c lÃ m viá»‡c Ä‘á»ƒ thá»±c hiá»‡n quÃ¡ trÃ¬nh tÃ­ch há»£p.
```

```bash
# Táº¡o thÆ° má»¥c lÃ m viá»‡c vá»›i timestamp
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
WORK_DIR="apk_integration_${TIMESTAMP}"
mkdir -p "${WORK_DIR}"/{source,target,output}
```

### 2a. Náº¿u Nguá»“n LÃ  Project Android: Build APK
```
Äang build APK tá»« project Android nguá»“n...
```

```bash
# Di chuyá»ƒn vÃ o thÆ° má»¥c project
cd "[Ä‘Æ°á»ng_dáº«n_project]"

# XÃ¡c Ä‘á»‹nh lá»‡nh Gradle
if [ -f "./gradlew" ]; then
  GRADLE_CMD="./gradlew"
else
  GRADLE_CMD="gradle"
fi

# Build APK vá»›i key debug máº·c Ä‘á»‹nh
echo "Äang build module [tÃªn_module] vá»›i key debug máº·c Ä‘á»‹nh..."
$GRADLE_CMD :[tÃªn_module]:assembleDebug

# TÃ¬m APK sau khi build
APK_PATH=$(find ./[tÃªn_module]/build/outputs -name "*.apk" | grep debug | head -1)

if [ -z "$APK_PATH" ]; then
  echo "KhÃ´ng tÃ¬m tháº¥y APK debug, thá»­ tÃ¬m APK release..."
  APK_PATH=$(find ./[tÃªn_module]/build/outputs -name "*.apk" | grep release | head -1)
fi

if [ -z "$APK_PATH" ]; then
  echo "KhÃ´ng tÃ¬m tháº¥y APK sau khi build. Vui lÃ²ng kiá»ƒm tra láº¡i project."
  exit 1
fi

# Copy APK Ä‘Ã£ build vÃ o thÆ° má»¥c lÃ m viá»‡c
cp "$APK_PATH" "${WORK_DIR}/source/source.apk"
echo "ÄÃ£ build vÃ  copy APK nguá»“n: $APK_PATH -> ${WORK_DIR}/source/source.apk"
```

### 2b. Náº¿u Nguá»“n LÃ  APK CÃ³ Sáºµn: Copy APK
```
Äang sao chÃ©p APK nguá»“n vÃ o thÆ° má»¥c lÃ m viá»‡c...
```

```bash
cp "[Ä‘Æ°á»ng_dáº«n_nguá»“n]" "${WORK_DIR}/source/source.apk"
```

### 3. Copy APK ÄÃ­ch
```
Äang sao chÃ©p APK Ä‘Ã­ch vÃ o thÆ° má»¥c lÃ m viá»‡c...
```

```bash
cp "[Ä‘Æ°á»ng_dáº«n_Ä‘Ã­ch]" "${WORK_DIR}/target/target.apk"
```

### 4. Decompile APK Nguá»“n
```
Äang decompile APK nguá»“n Ä‘á»ƒ truy cáº­p cÃ¡c file smali...
```

```bash
apktool d "${WORK_DIR}/source/source.apk" -o "${WORK_DIR}/source/decompiled" -f
```

### 5. Decompile APK ÄÃ­ch
```
Äang decompile APK Ä‘Ã­ch...
```

```bash
apktool d "${WORK_DIR}/target/target.apk" -o "${WORK_DIR}/target/decompiled" -f
```

### 6. Kiá»ƒm Tra Package Trong APK Nguá»“n
```
Äang kiá»ƒm tra package '[package_path]' trong APK nguá»“n...
```

```bash
# TÃ¬m package trong cÃ¡c thÆ° má»¥c smali
SOURCE_PACKAGE=""
for smali_dir in $(find "${WORK_DIR}/source/decompiled" -type d -name "smali*"); do
  if [ -d "${smali_dir}/[package_path]" ]; then
    SOURCE_PACKAGE="${smali_dir}/[package_path]"
    echo "ÄÃ£ tÃ¬m tháº¥y package táº¡i: ${SOURCE_PACKAGE}"
    break
  fi
done
```

Náº¿u khÃ´ng tÃ¬m tháº¥y package:
```
KhÃ´ng tÃ¬m tháº¥y package '[package_path]' trong APK nguá»“n.
CÃ¡c package cÃ³ sáºµn trong APK nguá»“n:
```

```bash
# Liá»‡t kÃª cÃ¡c package cáº¥p cao nháº¥t cÃ³ thá»ƒ tÃ¬m tháº¥y
for smali_dir in $(find "${WORK_DIR}/source/decompiled" -type d -name "smali*"); do
  find "$smali_dir" -mindepth 1 -maxdepth 3 -type d | sed "s|$smali_dir/||g" | sort | uniq | head -n 10
done
```

### 7. PhÃ¢n TÃ­ch Cáº¥u TrÃºc APK ÄÃ­ch
```
Äang phÃ¢n tÃ­ch cáº¥u trÃºc smali trong APK Ä‘Ã­ch Ä‘á»ƒ xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ tÃ­ch há»£p tá»‘i Æ°u...
```

```bash
# TÃ¬m táº¥t cáº£ cÃ¡c thÆ° má»¥c smali trong APK Ä‘Ã­ch
TARGET_SMALI_DIRS=()
for smali_dir in $(find "${WORK_DIR}/target/decompiled" -type d -name "smali*"); do
  TARGET_SMALI_DIRS+=("$smali_dir")
  echo "TÃ¬m tháº¥y thÆ° má»¥c smali: $(basename "$smali_dir")"
done

# Chá»n thÆ° má»¥c smali phÃ¹ há»£p hoáº·c táº¡o má»›i
if [ ${#TARGET_SMALI_DIRS[@]} -eq 0 ]; then
  DEST_SMALI="${WORK_DIR}/target/decompiled/smali"
  mkdir -p "$DEST_SMALI"
  echo "Táº¡o má»›i thÆ° má»¥c smali máº·c Ä‘á»‹nh"
else
  # Sá»­ dá»¥ng thÆ° má»¥c smali Ä‘áº§u tiÃªn hoáº·c smali_classes2 tÃ¹y theo tÃ¬nh huá»‘ng
  DEST_SMALI="${TARGET_SMALI_DIRS[0]}"
  echo "Sáº½ sá»­ dá»¥ng thÆ° má»¥c: $(basename "$DEST_SMALI")"
fi
```

### 8. TÃ­ch Há»£p Package
```
Äang tÃ­ch há»£p package '[package_path]' vÃ o APK Ä‘Ã­ch...
```

```bash
# Táº¡o thÆ° má»¥c cha náº¿u cáº§n
mkdir -p "$(dirname "${DEST_SMALI}/[package_path]")"

# Copy package
cp -r "${SOURCE_PACKAGE}" "$(dirname "${DEST_SMALI}/[package_path]")"
```

### 9. Kiá»ƒm Tra AndroidManifest.xml
```
Äang kiá»ƒm tra AndroidManifest.xml Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem cÃ³ cáº§n cáº­p nháº­t gÃ¬ khÃ´ng...
```

```bash
# Äá»•i Ä‘á»‹nh dáº¡ng package path tá»« com/example thÃ nh com.example
PACKAGE_DOT=$(echo "[package_path]" | tr '/' '.')

# Kiá»ƒm tra xem package cÃ³ trong manifest cá»§a APK nguá»“n khÃ´ng
if grep -q "$PACKAGE_DOT" "${WORK_DIR}/source/decompiled/AndroidManifest.xml"; then
  echo "Package xuáº¥t hiá»‡n trong AndroidManifest.xml cá»§a APK nguá»“n."
  echo "Báº¡n cÃ³ thá»ƒ cáº§n cáº­p nháº­t AndroidManifest.xml cá»§a APK Ä‘Ã­ch."
  
  # Hiá»ƒn thá»‹ cÃ¡c entries liÃªn quan
  grep -A 3 -B 3 "$PACKAGE_DOT" "${WORK_DIR}/source/decompiled/AndroidManifest.xml"
fi
```

### 10. Build Láº¡i APK ÄÃ­ch
```
Äang build láº¡i APK Ä‘Ã­ch vá»›i package Ä‘Ã£ tÃ­ch há»£p...
```

```bash
apktool b "${WORK_DIR}/target/decompiled" -o "${WORK_DIR}/output/integrated.apk"
```

### 11. KÃ½ APK Vá»›i Key Debug (TÃ¹y Chá»n)
```
Báº¡n cÃ³ muá»‘n kÃ½ APK vá»›i key debug khÃ´ng? (y/n)
```

Náº¿u ngÆ°á»i dÃ¹ng chá»n 'y':
```bash
echo "Äang kÃ½ APK vá»›i key debug máº·c Ä‘á»‹nh cá»§a Android..."
# XÃ¡c Ä‘á»‹nh vá»‹ trÃ­ debug.keystore
if [ -f "$HOME/.android/debug.keystore" ]; then
  DEBUG_KEYSTORE="$HOME/.android/debug.keystore"
elif [ -f "$ANDROID_SDK_ROOT/debug.keystore" ]; then
  DEBUG_KEYSTORE="$ANDROID_SDK_ROOT/debug.keystore"
else
  echo "KhÃ´ng tÃ¬m tháº¥y debug.keystore, sáº½ táº¡o keystore má»›i..."
  mkdir -p "$HOME/.android"
  keytool -genkey -v -keystore "$HOME/.android/debug.keystore" -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
  DEBUG_KEYSTORE="$HOME/.android/debug.keystore"
fi

# KÃ½ APK
jarsigner -sigalg SHA1withRSA -digestalg SHA1 -keystore "$DEBUG_KEYSTORE" -storepass android "${WORK_DIR}/output/integrated.apk" androiddebugkey

# Tá»‘i Æ°u APK
echo "Äang tá»‘i Æ°u APK vá»›i zipalign..."
zipalign -v 4 "${WORK_DIR}/output/integrated.apk" "${WORK_DIR}/output/integrated_aligned.apk"
mv "${WORK_DIR}/output/integrated_aligned.apk" "${WORK_DIR}/output/integrated.apk"
```

### 12. BÃ¡o CÃ¡o Káº¿t Quáº£
```
âœ… TÃ­ch há»£p hoÃ n táº¥t!

ğŸ“± APK Ä‘Ã£ tÃ­ch há»£p: ${WORK_DIR}/output/integrated.apk

ğŸ“‹ CÃ¡c bÆ°á»›c tiáº¿p theo:
1. CÃ i Ä‘áº·t APK: adb install -r "${WORK_DIR}/output/integrated.apk"
2. Kiá»ƒm tra cÃ¡c tÃ­nh nÄƒng Ä‘Ã£ tÃ­ch há»£p
3. Náº¿u cáº§n, chá»‰nh sá»­a AndroidManifest.xml thá»§ cÃ´ng

âš ï¸ LÆ°u Ã½: Náº¿u package yÃªu cáº§u resources hoáº·c cáº­p nháº­t AndroidManifest.xml, báº¡n cáº§n thá»±c hiá»‡n thÃªm cÃ¡c bÆ°á»›c bá»• sung.
```

## Xá»­ LÃ½ Lá»—i Phá»• Biáº¿n

### 1. Lá»—i Build Project Android
```
ÄÃ£ xáº£y ra lá»—i khi build project Android. NguyÃªn nhÃ¢n cÃ³ thá»ƒ lÃ :
1. Thiáº¿u SDK hoáº·c Build Tools
2. Xung Ä‘á»™t phiÃªn báº£n Gradle
3. Thiáº¿u dependencies

Log lá»—i:
[hiá»ƒn_thá»‹_log_lá»—i]

Khuyáº¿n nghá»‹:
1. Kiá»ƒm tra file local.properties trong project
2. Äáº£m báº£o Ä‘Ã£ cÃ i Ä‘áº·t cÃ¡c SDK version cáº§n thiáº¿t
3. Thá»­ build trá»±c tiáº¿p tá»« Android Studio
```

### 2. Lá»—i Decompile APK
```
ÄÃ£ xáº£y ra lá»—i khi decompile APK. ÄÃ¢y cÃ³ thá»ƒ do:
1. APK Ä‘Æ°á»£c báº£o vá»‡ hoáº·c Ä‘Ã³ng gÃ³i
2. PhiÃªn báº£n apktool khÃ´ng tÆ°Æ¡ng thÃ­ch
3. APK bá»‹ há»ng

Báº¡n cÃ³ muá»‘n thá»­ vá»›i cÃ¡c tÃ¹y chá»n khÃ¡c khÃ´ng?
```

### 3. Lá»—i Build APK
```
ÄÃ£ xáº£y ra lá»—i khi build láº¡i APK Ä‘Ã­ch. NguyÃªn nhÃ¢n cÃ³ thá»ƒ lÃ :
1. Xung Ä‘á»™t giá»¯a cÃ¡c class
2. PhiÃªn báº£n SDK khÃ´ng tÆ°Æ¡ng thÃ­ch
3. Thiáº¿u resources cáº§n thiáº¿t

Log lá»—i:
[hiá»ƒn_thá»‹_log_lá»—i]

Báº¡n cÃ³ muá»‘n thá»­ má»™t phÆ°Æ¡ng phÃ¡p khÃ¡c khÃ´ng?
```

## TrÆ°á»ng Há»£p Äáº·c Biá»‡t

### 1. Project Android KhÃ´ng Thá»ƒ Build
Náº¿u khÃ´ng thá»ƒ build project Android:
```
Project Android khÃ´ng thá»ƒ build Ä‘Æ°á»£c. Báº¡n cÃ³ thá»ƒ:
1. Cung cáº¥p APK Ä‘Ã£ build sáºµn thay tháº¿
2. Kiá»ƒm tra lá»—i vÃ  sá»­a project
3. Build manual báº±ng Android Studio

Báº¡n muá»‘n chá»n cÃ¡ch nÃ o?
```

### 2. TÃ­ch Há»£p Nhiá»u Package
Náº¿u cáº§n tÃ­ch há»£p nhiá»u package liÃªn quan, hÆ°á»›ng dáº«n:
```
Báº¡n muá»‘n tÃ­ch há»£p nhiá»u package. ChÃºng ta sáº½ thá»±c hiá»‡n láº§n lÆ°á»£t cho tá»«ng package:
1. [package1]
2. [package2]
3. [package3]

TÃ´i sáº½ báº¯t Ä‘áº§u vá»›i package Ä‘áº§u tiÃªn.
```

### 3. Package CÃ³ Resources
Náº¿u package cáº§n resources:
```
Package nÃ y cÃ³ thá»ƒ yÃªu cáº§u resources (hÃ¬nh áº£nh, layout, strings, v.v.).
CÃ¡c resources nÃ y náº±m trong thÆ° má»¥c 'res' cá»§a APK nguá»“n.

Báº¡n cÃ³ muá»‘n tÃ´i cÅ©ng sao chÃ©p cÃ¡c resources liÃªn quan khÃ´ng?
```

Náº¿u ngÆ°á»i dÃ¹ng Ä‘á»“ng Ã½:
```bash
# TÃ¬m cÃ¡c resources liÃªn quan (vÃ­ dá»¥ dá»±a trÃªn namespace)
RESOURCE_PREFIX=$(echo "[package_path]" | tr '/' '.' | cut -d '.' -f1-2)
mkdir -p "${WORK_DIR}/resources_related"

# TÃ¬m vÃ  copy cÃ¡c resources liÃªn quan
grep -r "$RESOURCE_PREFIX" "${WORK_DIR}/source/decompiled/res" --include="*.xml" -l | xargs -I{} cp {} "${WORK_DIR}/resources_related/"

echo "ÄÃ£ tÃ¬m tháº¥y $(ls "${WORK_DIR}/resources_related/" | wc -l) resources cÃ³ thá»ƒ liÃªn quan."
echo "Báº¡n cáº§n kiá»ƒm tra vÃ  tÃ­ch há»£p thá»§ cÃ´ng cÃ¡c resources nÃ y."
```

## VÃ­ Dá»¥ TÆ°Æ¡ng TÃ¡c (TÃ¹y Chá»n Project Android)

**NgÆ°á»i dÃ¹ng:** TÃ´i muá»‘n tÃ­ch há»£p má»™t package tá»« APK nÃ y sang APK khÃ¡c

**AI:**
```
TÃ´i sáº½ giÃºp báº¡n tÃ­ch há»£p package tá»« APK nguá»“n sang APK Ä‘Ã­ch.

Báº¡n muá»‘n sá»­ dá»¥ng:
1. Project Android Ä‘á»ƒ build APK nguá»“n
2. APK Ä‘Ã£ build sáºµn

Vui lÃ²ng chá»n tÃ¹y chá»n (1 hoáº·c 2):
```

**NgÆ°á»i dÃ¹ng:** 1

**AI:**
```
Vui lÃ²ng cung cáº¥p Ä‘Æ°á»ng dáº«n Ä‘áº¿n project Android nguá»“n:
```

**NgÆ°á»i dÃ¹ng:** /Users/trungkientn/Dev2/HuyDev/NewSdk2111

**AI:**
```
ÄÃ£ phÃ¢n tÃ­ch project Android. Dá»± Ã¡n cÃ³ cÃ¡c module sau:
- app
- safeads
- aichat-lite

Báº¡n muá»‘n build module nÃ o? (nháº­p tÃªn module, máº·c Ä‘á»‹nh lÃ  'app'):
```

**NgÆ°á»i dÃ¹ng:** app

**AI:**
```
ÄÆ°á»ng dáº«n Ä‘áº¿n file APK Ä‘Ã­ch (APK cáº§n Ä‘Æ°á»£c tÃ­ch há»£p package vÃ o) lÃ  gÃ¬?
```

**NgÆ°á»i dÃ¹ng:** /Users/trungkientn/Projects/MyApp/app/release/app-release.apk

**AI:**
```
Package hoáº·c class path báº¡n muá»‘n tÃ­ch há»£p lÃ  gÃ¬? (vÃ­ dá»¥: com/miui hoáº·c com/example/feature)
```

**NgÆ°á»i dÃ¹ng:** com/sdk/feature

**AI:**
```
TÃ´i sáº½ thá»±c hiá»‡n tÃ­ch há»£p vá»›i cÃ¡c thÃ´ng tin sau:
- Nguá»“n: Project Android táº¡i /Users/trungkientn/Dev2/HuyDev/NewSdk2111
- Module sáº½ build: app
- APK Ä‘Ã­ch: /Users/trungkientn/Projects/MyApp/app/release/app-release.apk
- Package cáº§n tÃ­ch há»£p: com/sdk/feature

Báº¡n xÃ¡c nháº­n lÃ  chÃ­nh xÃ¡c chá»©?
```

... (quÃ¡ trÃ¬nh tiáº¿p tá»¥c theo quy trÃ¬nh á»Ÿ trÃªn) 