---
description: 
globs: 
alwaysApply: false
---
# Quy Trình Tích Hợp APK Tương Tác
description: Quy trình tương tác để tích hợp package từ APK nguồn vào APK đích
globs: "**/*.{apk,smali,xml}"

## Nguyên Tắc Tương Tác
- ***BẮT BUỘC*** thu thập đầy đủ thông tin trước khi thực hiện
- ***BẮT BUỘC*** giải thích từng bước đang thực hiện
- ***BẮT BUỘC*** kiểm tra kết quả sau mỗi bước quan trọng
- ***KHUYẾN NGHỊ*** cung cấp thông tin hữu ích trong quá trình thực hiện

## Quy Trình Thu Thập Thông Tin
Khi nhận yêu cầu tích hợp APK, ***PHẢI*** thu thập đầy đủ các thông tin sau bằng cách hỏi tuần tự:

### 0. Xác Định Nguồn APK
```
Bạn muốn sử dụng:
1. Project Android để build APK nguồn
2. APK đã build sẵn

Vui lòng chọn tùy chọn (1 hoặc 2):
```

### 1a. Nếu Chọn Project Android
```
Vui lòng cung cấp đường dẫn đến project Android nguồn:
```

Sau đó phân tích project:
```bash
# Kiểm tra Gradle wrapper
if [ -f "[đường_dẫn_project]/gradlew" ]; then
  chmod +x "[đường_dẫn_project]/gradlew"
  echo "Đã tìm thấy Gradle wrapper"
else
  echo "Không tìm thấy Gradle wrapper, sẽ sử dụng Gradle toàn cục"
fi

# Liệt kê các module
MODULES=$(grep "include " "[đường_dẫn_project]/settings.gradle" | sed -e "s/include//g" -e "s/'//g" -e "s/://g" -e "s/,//g")
echo "Các module có thể build: $MODULES"
```

Hỏi người dùng:
```
Dự án có các module sau:
[danh_sách_modules]

Bạn muốn build module nào? (nhập tên module, mặc định là 'app'):
```

### 1b. Nếu Chọn APK Đã Build Sẵn
```
Bạn vui lòng cung cấp đường dẫn đến file APK nguồn (chứa package cần tích hợp):
```

### 2. APK Đích
```
Đường dẫn đến file APK đích (APK cần được tích hợp package vào) là gì?
```

### 3. Package/Class Path
```
Package hoặc class path bạn muốn tích hợp là gì? (ví dụ: com/miui hoặc com/example/feature)
```

### 4. Xác Nhận Thông Tin
```
Tôi sẽ thực hiện tích hợp với các thông tin sau:
- Nguồn: [Project Android / APK nguồn]
- [Nếu là Project] Module sẽ build: [tên_module]
- APK đích: [đường_dẫn_đích]
- Package cần tích hợp: [package_path]

Bạn xác nhận là chính xác chứ?
```

## Quy Trình Thực Hiện
Sau khi thu thập đủ thông tin, thực hiện các bước sau:

### 1. Tạo Thư Mục Làm Việc
```
Tôi sẽ tạo thư mục làm việc để thực hiện quá trình tích hợp.
```

```bash
# Tạo thư mục làm việc với timestamp
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
WORK_DIR="apk_integration_${TIMESTAMP}"
mkdir -p "${WORK_DIR}"/{source,target,output}
```

### 2a. Nếu Nguồn Là Project Android: Build APK
```
Đang build APK từ project Android nguồn...
```

```bash
# Di chuyển vào thư mục project
cd "[đường_dẫn_project]"

# Xác định lệnh Gradle
if [ -f "./gradlew" ]; then
  GRADLE_CMD="./gradlew"
else
  GRADLE_CMD="gradle"
fi

# Build APK với key debug mặc định
echo "Đang build module [tên_module] với key debug mặc định..."
$GRADLE_CMD :[tên_module]:assembleDebug

# Tìm APK sau khi build
APK_PATH=$(find ./[tên_module]/build/outputs -name "*.apk" | grep debug | head -1)

if [ -z "$APK_PATH" ]; then
  echo "Không tìm thấy APK debug, thử tìm APK release..."
  APK_PATH=$(find ./[tên_module]/build/outputs -name "*.apk" | grep release | head -1)
fi

if [ -z "$APK_PATH" ]; then
  echo "Không tìm thấy APK sau khi build. Vui lòng kiểm tra lại project."
  exit 1
fi

# Copy APK đã build vào thư mục làm việc
cp "$APK_PATH" "${WORK_DIR}/source/source.apk"
echo "Đã build và copy APK nguồn: $APK_PATH -> ${WORK_DIR}/source/source.apk"
```

### 2b. Nếu Nguồn Là APK Có Sẵn: Copy APK
```
Đang sao chép APK nguồn vào thư mục làm việc...
```

```bash
cp "[đường_dẫn_nguồn]" "${WORK_DIR}/source/source.apk"
```

### 3. Copy APK Đích
```
Đang sao chép APK đích vào thư mục làm việc...
```

```bash
cp "[đường_dẫn_đích]" "${WORK_DIR}/target/target.apk"
```

### 4. Decompile APK Nguồn
```
Đang decompile APK nguồn để truy cập các file smali...
```

```bash
apktool d "${WORK_DIR}/source/source.apk" -o "${WORK_DIR}/source/decompiled" -f
```

### 5. Decompile APK Đích
```
Đang decompile APK đích...
```

```bash
apktool d "${WORK_DIR}/target/target.apk" -o "${WORK_DIR}/target/decompiled" -f
```

### 6. Kiểm Tra Package Trong APK Nguồn
```
Đang kiểm tra package '[package_path]' trong APK nguồn...
```

```bash
# Tìm package trong các thư mục smali
SOURCE_PACKAGE=""
for smali_dir in $(find "${WORK_DIR}/source/decompiled" -type d -name "smali*"); do
  if [ -d "${smali_dir}/[package_path]" ]; then
    SOURCE_PACKAGE="${smali_dir}/[package_path]"
    echo "Đã tìm thấy package tại: ${SOURCE_PACKAGE}"
    break
  fi
done
```

Nếu không tìm thấy package:
```
Không tìm thấy package '[package_path]' trong APK nguồn.
Các package có sẵn trong APK nguồn:
```

```bash
# Liệt kê các package cấp cao nhất có thể tìm thấy
for smali_dir in $(find "${WORK_DIR}/source/decompiled" -type d -name "smali*"); do
  find "$smali_dir" -mindepth 1 -maxdepth 3 -type d | sed "s|$smali_dir/||g" | sort | uniq | head -n 10
done
```

### 7. Phân Tích Cấu Trúc APK Đích
```
Đang phân tích cấu trúc smali trong APK đích để xác định vị trí tích hợp tối ưu...
```

```bash
# Tìm tất cả các thư mục smali trong APK đích
TARGET_SMALI_DIRS=()
for smali_dir in $(find "${WORK_DIR}/target/decompiled" -type d -name "smali*"); do
  TARGET_SMALI_DIRS+=("$smali_dir")
  echo "Tìm thấy thư mục smali: $(basename "$smali_dir")"
done

# Chọn thư mục smali phù hợp hoặc tạo mới
if [ ${#TARGET_SMALI_DIRS[@]} -eq 0 ]; then
  DEST_SMALI="${WORK_DIR}/target/decompiled/smali"
  mkdir -p "$DEST_SMALI"
  echo "Tạo mới thư mục smali mặc định"
else
  # Sử dụng thư mục smali đầu tiên hoặc smali_classes2 tùy theo tình huống
  DEST_SMALI="${TARGET_SMALI_DIRS[0]}"
  echo "Sẽ sử dụng thư mục: $(basename "$DEST_SMALI")"
fi
```

### 8. Tích Hợp Package
```
Đang tích hợp package '[package_path]' vào APK đích...
```

```bash
# Tạo thư mục cha nếu cần
mkdir -p "$(dirname "${DEST_SMALI}/[package_path]")"

# Copy package
cp -r "${SOURCE_PACKAGE}" "$(dirname "${DEST_SMALI}/[package_path]")"
```

### 9. Kiểm Tra AndroidManifest.xml
```
Đang kiểm tra AndroidManifest.xml để xác định xem có cần cập nhật gì không...
```

```bash
# Đổi định dạng package path từ com/example thành com.example
PACKAGE_DOT=$(echo "[package_path]" | tr '/' '.')

# Kiểm tra xem package có trong manifest của APK nguồn không
if grep -q "$PACKAGE_DOT" "${WORK_DIR}/source/decompiled/AndroidManifest.xml"; then
  echo "Package xuất hiện trong AndroidManifest.xml của APK nguồn."
  echo "Bạn có thể cần cập nhật AndroidManifest.xml của APK đích."
  
  # Hiển thị các entries liên quan
  grep -A 3 -B 3 "$PACKAGE_DOT" "${WORK_DIR}/source/decompiled/AndroidManifest.xml"
fi
```

### 10. Build Lại APK Đích
```
Đang build lại APK đích với package đã tích hợp...
```

```bash
apktool b "${WORK_DIR}/target/decompiled" -o "${WORK_DIR}/output/integrated.apk"
```

### 11. Ký APK Với Key Debug (Tùy Chọn)
```
Bạn có muốn ký APK với key debug không? (y/n)
```

Nếu người dùng chọn 'y':
```bash
echo "Đang ký APK với key debug mặc định của Android..."
# Xác định vị trí debug.keystore
if [ -f "$HOME/.android/debug.keystore" ]; then
  DEBUG_KEYSTORE="$HOME/.android/debug.keystore"
elif [ -f "$ANDROID_SDK_ROOT/debug.keystore" ]; then
  DEBUG_KEYSTORE="$ANDROID_SDK_ROOT/debug.keystore"
else
  echo "Không tìm thấy debug.keystore, sẽ tạo keystore mới..."
  mkdir -p "$HOME/.android"
  keytool -genkey -v -keystore "$HOME/.android/debug.keystore" -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
  DEBUG_KEYSTORE="$HOME/.android/debug.keystore"
fi

# Ký APK
jarsigner -sigalg SHA1withRSA -digestalg SHA1 -keystore "$DEBUG_KEYSTORE" -storepass android "${WORK_DIR}/output/integrated.apk" androiddebugkey

# Tối ưu APK
echo "Đang tối ưu APK với zipalign..."
zipalign -v 4 "${WORK_DIR}/output/integrated.apk" "${WORK_DIR}/output/integrated_aligned.apk"
mv "${WORK_DIR}/output/integrated_aligned.apk" "${WORK_DIR}/output/integrated.apk"
```

### 12. Báo Cáo Kết Quả
```
✅ Tích hợp hoàn tất!

📱 APK đã tích hợp: ${WORK_DIR}/output/integrated.apk

📋 Các bước tiếp theo:
1. Cài đặt APK: adb install -r "${WORK_DIR}/output/integrated.apk"
2. Kiểm tra các tính năng đã tích hợp
3. Nếu cần, chỉnh sửa AndroidManifest.xml thủ công

⚠️ Lưu ý: Nếu package yêu cầu resources hoặc cập nhật AndroidManifest.xml, bạn cần thực hiện thêm các bước bổ sung.
```

## Xử Lý Lỗi Phổ Biến

### 1. Lỗi Build Project Android
```
Đã xảy ra lỗi khi build project Android. Nguyên nhân có thể là:
1. Thiếu SDK hoặc Build Tools
2. Xung đột phiên bản Gradle
3. Thiếu dependencies

Log lỗi:
[hiển_thị_log_lỗi]

Khuyến nghị:
1. Kiểm tra file local.properties trong project
2. Đảm bảo đã cài đặt các SDK version cần thiết
3. Thử build trực tiếp từ Android Studio
```

### 2. Lỗi Decompile APK
```
Đã xảy ra lỗi khi decompile APK. Đây có thể do:
1. APK được bảo vệ hoặc đóng gói
2. Phiên bản apktool không tương thích
3. APK bị hỏng

Bạn có muốn thử với các tùy chọn khác không?
```

### 3. Lỗi Build APK
```
Đã xảy ra lỗi khi build lại APK đích. Nguyên nhân có thể là:
1. Xung đột giữa các class
2. Phiên bản SDK không tương thích
3. Thiếu resources cần thiết

Log lỗi:
[hiển_thị_log_lỗi]

Bạn có muốn thử một phương pháp khác không?
```

## Trường Hợp Đặc Biệt

### 1. Project Android Không Thể Build
Nếu không thể build project Android:
```
Project Android không thể build được. Bạn có thể:
1. Cung cấp APK đã build sẵn thay thế
2. Kiểm tra lỗi và sửa project
3. Build manual bằng Android Studio

Bạn muốn chọn cách nào?
```

### 2. Tích Hợp Nhiều Package
Nếu cần tích hợp nhiều package liên quan, hướng dẫn:
```
Bạn muốn tích hợp nhiều package. Chúng ta sẽ thực hiện lần lượt cho từng package:
1. [package1]
2. [package2]
3. [package3]

Tôi sẽ bắt đầu với package đầu tiên.
```

### 3. Package Có Resources
Nếu package cần resources:
```
Package này có thể yêu cầu resources (hình ảnh, layout, strings, v.v.).
Các resources này nằm trong thư mục 'res' của APK nguồn.

Bạn có muốn tôi cũng sao chép các resources liên quan không?
```

Nếu người dùng đồng ý:
```bash
# Tìm các resources liên quan (ví dụ dựa trên namespace)
RESOURCE_PREFIX=$(echo "[package_path]" | tr '/' '.' | cut -d '.' -f1-2)
mkdir -p "${WORK_DIR}/resources_related"

# Tìm và copy các resources liên quan
grep -r "$RESOURCE_PREFIX" "${WORK_DIR}/source/decompiled/res" --include="*.xml" -l | xargs -I{} cp {} "${WORK_DIR}/resources_related/"

echo "Đã tìm thấy $(ls "${WORK_DIR}/resources_related/" | wc -l) resources có thể liên quan."
echo "Bạn cần kiểm tra và tích hợp thủ công các resources này."
```

## Ví Dụ Tương Tác (Tùy Chọn Project Android)

**Người dùng:** Tôi muốn tích hợp một package từ APK này sang APK khác

**AI:**
```
Tôi sẽ giúp bạn tích hợp package từ APK nguồn sang APK đích.

Bạn muốn sử dụng:
1. Project Android để build APK nguồn
2. APK đã build sẵn

Vui lòng chọn tùy chọn (1 hoặc 2):
```

**Người dùng:** 1

**AI:**
```
Vui lòng cung cấp đường dẫn đến project Android nguồn:
```

**Người dùng:** /Users/trungkientn/Dev2/HuyDev/NewSdk2111

**AI:**
```
Đã phân tích project Android. Dự án có các module sau:
- app
- safeads
- aichat-lite

Bạn muốn build module nào? (nhập tên module, mặc định là 'app'):
```

**Người dùng:** app

**AI:**
```
Đường dẫn đến file APK đích (APK cần được tích hợp package vào) là gì?
```

**Người dùng:** /Users/trungkientn/Projects/MyApp/app/release/app-release.apk

**AI:**
```
Package hoặc class path bạn muốn tích hợp là gì? (ví dụ: com/miui hoặc com/example/feature)
```

**Người dùng:** com/sdk/feature

**AI:**
```
Tôi sẽ thực hiện tích hợp với các thông tin sau:
- Nguồn: Project Android tại /Users/trungkientn/Dev2/HuyDev/NewSdk2111
- Module sẽ build: app
- APK đích: /Users/trungkientn/Projects/MyApp/app/release/app-release.apk
- Package cần tích hợp: com/sdk/feature

Bạn xác nhận là chính xác chứ?
```

... (quá trình tiếp tục theo quy trình ở trên) 